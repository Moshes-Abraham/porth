// In progress rewrite of test.py in porth
include "std.porth"

proc run-file
  ptr // file-name
in
  tmp-end
    "./porth.py"c   tmp-append-ptr
    "com"c          tmp-append-ptr
    over            tmp-append-ptr
    NULL            tmp-append-ptr
    dup true cmd-echoed

    over cstr-to-str remove-ext tmp-str-to-cstr
      tmp-end
        over         tmp-append-ptr
        NULL         tmp-append-ptr
        dup true cmd-echoed
      tmp-rewind
    drop
  tmp-rewind
  drop

  here eputs ": TODO: run-file is not fully implemented yet\n" eputs
  1 exit
end

proc main in
  memory args sizeof(ptr) end
  argv args !ptr

  memory program sizeof(ptr) end
  args @@ptr program !ptr
  args sizeof(ptr) inc64-by

  args @@ptr NULL ptr= if
    "ERROR: no subcommand was provided!\n" eputs
    1 exit
  end

  args @@ptr
  args sizeof(ptr) inc64-by
    dup "run"c cstreq if
      args @@ptr NULL ptr= if
        "ERROR: no target was provided for the `run` subcommand\n" eputs
        1 exit
      end
      args @@ptr run-file
    else dup "update"c cstreq if*
      here eputs ": TODO: `update` subcommand is not implemented\n" eputs
      1 exit
    else dup "help"c cstreq if*
      here eputs ": TODO: `help` subcommand is not implemented\n" eputs
      1 exit
    else
      "ERROR: unknown subcommand `" eputs
      dup cstr-to-str               eputs
      "`\n"                         eputs
      1 exit
    end
  drop

end

main
